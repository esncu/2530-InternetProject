<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="styles.css">
    <script src='session.js'></script>
    <script src="data.js"></script>
    <title>Impian - Thank You!</title>
    <style>
      /* reset styles.css */
      #main-content{
        padding: 52px 0 0 0;
      }
      body{
        display: inline;
        background-color: var(--bg-color);
        height: 100vh;
      }
      /* reset styles.css */
      h1{
        text-align: center;
        font-size: 70px;
      }
      td, th{
        border: 1px solid var(--sec-color);
        text-overflow: ellipsis;
      }
      table{
        margin: 0 auto 0 auto;
        width: 90%;
      }
    </style>
  </head>


  <body>
    <header id='topbar'>
      <a href="index.html"><img src="./media/logo.webp" id='topbar-logo'></a>
      <div id='topbar-nav'>
        <a href="cart.html"><img src="./media/cart.png"></a>
        <a href="panel.html"><img src="./media/user.png"></a>
      </div>
    </header>

    <div id='main-content'>
      <h1>Thank you for shopping at iMPIAN.MY!</h1>
      <table id='receiptOutput'>
        <th colspan='5'>Purchase details:</th>
      </table>
    </div>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded",()=>{window.onDataReady = () => {
      const params = new URLSearchParams(window.location.search);
      const address = params.get("address");
      const method = params.get("paymentMethod");
      const table = document.getElementById('receiptOutput');

      const rawCart = localStorage.getItem('cart');
      const cart = rawCart ? JSON.parse(rawCart) : [];

      const newReceipt = {
        address,
        paymentMethod: method,
        items: cart.map(item => ({
          id: item.id,
          quantity: item.quantity
        }))
      };

      const rawReceipts = localStorage.getItem('receipts');
      const receipts = rawReceipts ? JSON.parse(rawReceipts): [];

      receipts.push(newReceipt);

      const headers = document.createElement("tr");
      headers.innerHTML = `
        <th>Shop</th>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Total</th>
      `;
      table.appendChild(headers);

      cart.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.shopName}</td>
          <td>${item.name}</td>
          <td>RM&nbsp;${item.price}</td>
          <td>${item.quantity}</td>
          <td>RM&nbsp;${(item.price * item.quantity).toFixed(2)}</td>
        `;

        table.appendChild(row);
      });

      localStorage.setItem('receipts', JSON.stringify(receipts));
      localStorage.removeItem('cart');
    }});
  </script>
</html>
